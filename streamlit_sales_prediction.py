# -*- coding: utf-8 -*-
"""streamlit sales prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1SpzhbhsHq_nSlkH0yNi0OQkDGPx4CBjy
"""

import streamlit as st
import pandas as pd
import joblib
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error

st.set_page_config(layout='wide')
st.title('Prediction Monthly Item')

#upload data
upload_file = st.file_uploader("Upload Your CSV file", type=['csv'])
if upload_file:
  df = pd.read_csv(upload_file)
  df['Order Date'] = pd.to_datetime(df['Order Date'], errors='coerce')
  df = df.dropna(subset=['Order Date', 'Profit'])
  df['Month'] = df['Order Date'].dt.to_period('M')

  # Load model and encoders
  bundle = joblib.load('new_profit_model.pkl')
  model = bundle['model']
  le_subcat = bundle['le_subcat']
  le_state = bundle['le_state']
  le_city = bundle['le_city']

  # Apply same encodings as training
  df['Sub-Category'] = le_subcat.transform(df['Sub-Category'])
  df['State'] = le_state.transform(df['State'])
  df['City'] = le_city.transform(df['City'])

  monthly_data = (
    df.groupby(['Month', 'Sub-Category', 'State', 'City'])
      .agg({'Quantity': 'sum', 'Amount': 'sum', 'Profit': 'sum'})
      .reset_index()
  )

  monthly_data['Month'] = monthly_data['Month'].astype(str)

  next_month_input = (
    monthly_data.groupby(['Sub-Category', 'State', 'City'])
    .agg({'Quantity': 'mean', 'Amount': 'mean'})
    .reset_index()
  )

  # Remove get_dummies and just use these encoded columns
  X_future = next_month_input[['Sub-Category', 'State', 'City', 'Quantity', 'Amount']]
  X_future = X_future.reindex(columns=X.columns, fill_value=0)

  

  future_profit = model.predict(X_future)
  next_month_input['Predicted_Profit'] = future_profit

  top10 = next_month_input.sort_values(by='Predicted_Profit', ascending=False).head(10)

  st.dataframe(top10)
